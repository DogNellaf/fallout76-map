<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fallout 76 Map</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
  <link rel="stylesheet" href="./assets/css/leaflet.css"/>
  <link rel="stylesheet" href="./assets/css/Control.FullScreen.css" />
  <link rel="stylesheet" href="./assets/css/leaflet-search.css" />
  <link rel="stylesheet" href="./assets/css/leaflet-control-condended-attribution.css" />
  <link rel="stylesheet" href="./assets/css/normalize.css" />
  <link rel="stylesheet" href="./assets/css/main.css" />
  <link rel="stylesheet" href="./assets/css/f76map.css" />
</head>
<body>
  <div id="mapid"></div>

  <script src="./assets/js/leaflet.js?v=1.4.0"></script>
  <script src="./assets/js/rastercoords.js"></script> 
  <script src="./assets/js/Control.FullScreen.js"></script>
  <script src="./assets/js/leaflet-search.js"></script>
  <script src="./assets/js/leaflet-control-condended-attribution.js"></script>
  <script src="./assets/js/Leaflet.Icon.Glyph.js"></script>
  <script src="./assets/js/main.js"></script>
  <script src="./assets/js/leaflet-image.js"></script>
  
    <script>
// –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ main.js
var markedMarkers = new Map(); // –•—Ä–∞–Ω–∏—Ç ID –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–æ–∫

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID –º–µ—Ç–∫–∏
function generateMarkerId(marker) {
    const latlng = marker.getLatLng();
    const title = marker.options.title || '';
    return `${latlng.lat.toFixed(6)}_${latlng.lng.toFixed(6)}_${title.replace(/[^a-zA-Z0-9]/g, '_')}`;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏/—Å–Ω—è—Ç–∏—è –æ—Ç–º–µ—Ç–∫–∏ —Å –º–µ—Ç–∫–∏
function toggleMarkerMark(marker) {
    const markerId = generateMarkerId(marker);
    console.log('Toggle marker:', markerId);
    
    if (markedMarkers.has(markerId)) {
        // –°–Ω–∏–º–∞–µ–º –æ—Ç–º–µ—Ç–∫—É
        marker.setOpacity(1);
        markedMarkers.delete(markerId);
        console.log('Marker unmarked');
    } else {
        // –°—Ç–∞–≤–∏–º –æ—Ç–º–µ—Ç–∫—É
        marker.setOpacity(0.5);
        markedMarkers.set(markerId, {
            lat: marker.getLatLng().lat,
            lng: marker.getLatLng().lng,
            title: marker.options.title || '',
            timestamp: new Date().toISOString()
        });
        console.log('Marker marked');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
    saveMarkedMarkers();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
    updateMarkedCounter();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ localStorage
function saveMarkedMarkers() {
    const markersArray = Array.from(markedMarkers.entries());
    console.log('Saving markers to localStorage:', markersArray.length);
    localStorage.setItem('markedMarkers', JSON.stringify(markersArray));
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –∫–∞–∫ –æ–±—ä–µ–∫—Ç –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    const markersObject = {};
    markersArray.forEach(([id, data]) => {
        markersObject[id] = data;
    });
    localStorage.setItem('markedMarkersObject', JSON.stringify(markersObject));
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –∏–∑ localStorage
function loadMarkedMarkers() {
    console.log('Loading markers from localStorage...');
    const saved = localStorage.getItem('markedMarkers');
    
    if (saved) {
        try {
            const markersArray = JSON.parse(saved);
            console.log('Loaded markers array:', markersArray.length);
            
            markedMarkers.clear();
            markersArray.forEach(([id, data]) => {
                markedMarkers.set(id, data);
            });
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ –≤—Å–µ–º –º–µ—Ç–∫–∞–º –Ω–∞ –∫–∞—Ä—Ç–µ
            applyMarkedMarkers();
            updateMarkedCounter();
            console.log('Markers loaded and applied successfully');
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫:', e);
        }
    } else {
        console.log('No saved markers found');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫ –º–µ—Ç–∫–∞–º
function applyMarkedMarkers() {
    console.log('Applying marked markers...');
    let appliedCount = 0;
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Å–æ –≤—Å–µ—Ö —Å–ª–æ–µ–≤
    const allLayers = [ol_pa, ol_vault, ol_loc, ol_loc2, ol_train, ol_pwr, ol_map, ol_tape, ol_wb, ol_rift, ol_event, ol_locv];
    
    allLayers.forEach(layer => {
        if (layer && typeof layer.eachLayer === 'function') {
            layer.eachLayer(marker => {
                if (marker instanceof L.Marker) {
                    try {
                        const markerId = generateMarkerId(marker);
                        if (markedMarkers.has(markerId)) {
                            marker.setOpacity(0.5);
                            appliedCount++;
                            console.log('Applied mark to:', markerId);
                        }
                    } catch (e) {
                        console.error('Error applying marker:', e);
                    }
                }
            });
        }
    });
    
    console.log(`Applied marks to ${appliedCount} markers`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
function updateMarkedCounter() {
    const counter = document.getElementById('markedCounter');
    if (counter) {
        counter.textContent = `–û—Ç–º–µ—á–µ–Ω–æ: ${markedMarkers.size}`;
    }
}

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ tooltipTemplate
window.tooltipTemplate = function(title, bobblehead=0, magazine=0, capstash=0, recipe='') {
    var result = '<div class="tooltip">';
    result += '<div class="tooltip-header">';
    result += '<div class="tooltitle">'+title+'</div>';
    result += '<button class="mark-button" onclick="window.markButtonClick(event)">‚úì</button>';
    result += '</div>';
    if (bobblehead) result += '<div>Bobblehead: x' + bobblehead + '</div>';
    if (magazine) result += '<div>Magazine: x' + magazine + '</div>';
    if (capstash) result += '<div>Cap Stash: x' + capstash + '</div>';
    if (recipe) result += '<div>Recipe/Plan: x' + recipe + '</div>';
    result += '</div>';
    return result;
};

window.tooltipMapTemplate = function(title, img='', text='') {
    var result = '<div class="tooltip">';
    result += '<div class="tooltip-header">';
    result += '<div class="tooltitle">'+title+'</div>';
    result += '<button class="mark-button" onclick="window.markButtonClick(event)">‚úì</button>';
    result += '</div>';
    if (img) result += '<div><img src="assets/img/treasure/' + img + '"/></div>';
    if (text) result += '<div>' + text + '</div>';
    result += '</div>';
    return result;
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–º–µ—Ç–∫–∏ –≤ —Ç—É–ª—Ç–∏–ø–µ
window.markButtonClick = function(event) {
    event.stopPropagation();
    event.preventDefault();
    
    const tooltip = event.target.closest('.leaflet-tooltip');
    if (!tooltip) return;
    
    // –ù–∞—Ö–æ–¥–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã–π –º–∞—Ä–∫–µ—Ä
    const markerElement = tooltip._source && tooltip._source._icon;
    if (!markerElement) {
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const allMarkers = [];
        const allLayers = [ol_pa, ol_vault, ol_loc, ol_loc2, ol_train, ol_pwr, ol_map, ol_tape, ol_wb, ol_rift, ol_event, ol_locv];
        
        allLayers.forEach(layer => {
            if (layer && typeof layer.eachLayer === 'function') {
                layer.eachLayer(marker => {
                    if (marker instanceof L.Marker && marker.getTooltip() === tooltip) {
                        allMarkers.push(marker);
                    }
                });
            }
        });
        
        if (allMarkers.length > 0) {
            toggleMarkerMark(allMarkers[0]);
        }
        return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º –º–∞—Ä–∫–µ—Ä —á–µ—Ä–µ–∑ Leaflet
    let targetMarker = null;
    map.eachLayer(function(layer) {
        if (layer instanceof L.Marker && layer._icon === markerElement) {
            targetMarker = layer;
        }
    });
    
    if (targetMarker) {
        toggleMarkerMark(targetMarker);
    }
};

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
function addClickHandlersToMarkers() {
    const allLayers = [ol_pa, ol_vault, ol_loc, ol_loc2, ol_train, ol_pwr, ol_map, ol_tape, ol_wb, ol_rift, ol_event, ol_locv];
    
    allLayers.forEach(layer => {
        if (layer && typeof layer.eachLayer === 'function') {
            layer.eachLayer(marker => {
                if (marker instanceof L.Marker) {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
                    marker.off('click.toggleMark');
                    marker.on('click.toggleMark', function(e) {
                        toggleMarkerMark(e.target);
                    });
                }
            });
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è –æ—Ç–º–µ—Ç–æ–∫ —Å–æ –≤—Å–µ—Ö –º–µ—Ç–æ–∫
function clearAllMarks() {
    if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏?')) return;
    
    const allLayers = [ol_pa, ol_vault, ol_loc, ol_loc2, ol_train, ol_pwr, ol_map, ol_tape, ol_wb, ol_rift, ol_event, ol_locv];
    
    allLayers.forEach(layer => {
        if (layer && typeof layer.eachLayer === 'function') {
            layer.eachLayer(marker => {
                if (marker instanceof L.Marker) {
                    marker.setOpacity(1);
                }
            });
        }
    });
    
    markedMarkers.clear();
    saveMarkedMarkers();
    updateMarkedCounter();
    alert('–í—Å–µ –æ—Ç–º–µ—Ç–∫–∏ –æ—á–∏—â–µ–Ω—ã!');
}

// –î–æ–±–∞–≤–ª—è–µ–º CSS —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
document.addEventListener('DOMContentLoaded', function() {
    const style = document.createElement('style');
    style.textContent = `
        .mark-button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .mark-button:hover {
            background: #45a049;
        }
        
        .mark-button.marked {
            background: #f44336;
        }
        
        .mark-button.marked:hover {
            background: #d32f2f;
        }
        
        .tooltip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .marker-controls {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            font-size: 12px;
        }
        
        .marker-controls button {
            margin: 2px;
            padding: 5px 10px;
            border: none;
            background: #f8f9fa;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .marker-controls button:hover {
            background: #e9ecef;
        }
        
        #markedCounter {
            margin: 5px;
            font-weight: bold;
            color: #4CAF50;
        }
    `;
    document.head.appendChild(style);
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const controlDiv = document.createElement('div');
    controlDiv.className = 'leaflet-control leaflet-bar marker-controls';
    controlDiv.innerHTML = `
        <div id="markedCounter">–û—Ç–º–µ—á–µ–Ω–æ: 0</div>
        <button id="saveMarks" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–º–µ—Ç–∫–∏">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="loadMarks" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–º–µ—Ç–∫–∏">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        <button id="clearMarks" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –æ—Ç–º–µ—Ç–∫–∏">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –∫–∞—Ä—Ç—É
    L.Control.MarkerControls = L.Control.extend({
        onAdd: function(map) {
            return controlDiv;
        }
    });
    
    new L.Control.MarkerControls({position: 'topright'}).addTo(map);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    document.getElementById('saveMarks').addEventListener('click', function() {
        saveMarkedMarkers();
        alert('–û—Ç–º–µ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    });
    
    document.getElementById('loadMarks').addEventListener('click', function() {
        loadMarkedMarkers();
    });
    
    document.getElementById('clearMarks').addEventListener('click', clearAllMarks);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(function() {
        addClickHandlersToMarkers();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadMarkedMarkers();
    }, 1000);
});

// –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–º–µ—Ç–∫–∏
map.on('dblclick', function(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É
    if (e.originalEvent.target.closest('.leaflet-marker-icon')) {
        const markerElement = e.originalEvent.target.closest('.leaflet-marker-icon');
        
        // –ò—â–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Å–ª–æ—è—Ö –∫–∞—Ä—Ç—ã
        let targetMarker = null;
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker && layer._icon === markerElement) {
                targetMarker = layer;
            }
        });
        
        if (targetMarker) {
            toggleMarkerMark(targetMarker);
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ JSON —Ñ–∞–π–ª
window.exportMarkedMarkers = function() {
    const exportData = {
        timestamp: new Date().toISOString(),
        totalMarkers: markedMarkers.size,
        markers: Array.from(markedMarkers.entries())
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `marked-markers-${new Date().toISOString().slice(0,10)}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –∏–∑ JSON —Ñ–∞–π–ª–∞
window.importMarkedMarkers = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importData = JSON.parse(e.target.result);
            
            if (!importData.markers || !Array.isArray(importData.markers)) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
            }
            
            markedMarkers.clear();
            
            importData.markers.forEach(([id, data]) => {
                markedMarkers.set(id, data);
            });
            
            applyMarkedMarkers();
            saveMarkedMarkers();
            updateMarkedCounter();
            
            alert(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importData.markers.length} –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫`);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞: ' + error.message);
        }
    };
    reader.readAsText(file);
};

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
setTimeout(function() {
    const controlDiv = document.querySelector('.marker-controls');
    if (controlDiv) {
        const importExportDiv = document.createElement('div');
        importExportDiv.style.marginTop = '5px';
        importExportDiv.innerHTML = `
            <input type="file" id="importFile" accept=".json" style="display: none" onchange="importMarkedMarkers(event)">
            <button onclick="exportMarkedMarkers()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button onclick="document.getElementById('importFile').click()" title="–ò–º–ø–æ—Ä—Ç –∏–∑ JSON">üì• –ò–º–ø–æ—Ä—Ç</button>
        `;
        controlDiv.appendChild(importExportDiv);
    }
}, 1500);
  </script>
</body>
</html>